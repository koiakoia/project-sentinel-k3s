apiVersion: v1
kind: ConfigMap
metadata:
  name: litellm-config
  namespace: sentinel
data:
  config.yaml: |-
    model_list:
      - model_name: llama3.1
        litellm_params:
          model: ollama/llama3.1
          api_base: "http://ollama.sentinel.svc.cluster.local:11434"
          num_ctx: 16384
      - model_name: gemini-stable-cloud
        litellm_params:
          model: gemini/gemini-pro
          api_base: "https://generativelanguage.googleapis.com"
          api_key: os.environ/GEMINI_API_KEY
---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: paperless-sync-job
  namespace: sentinel
spec:
  schedule: "*/15 * * * *"  # Runs every 15 minutes
  successfulJobsHistoryLimit: 1
  failedJobsHistoryLimit: 1
  jobTemplate:
    spec:
      template:
        spec:
          containers:
          - name: syncer
            image: python:3.12-slim
            command:
            - /bin/bash
            - -c
            - |
              pip install requests >/dev/null 2>&1
              python -c '
              import requests
              import json
              import sys

              # --- CONFIG ---
              # Service names valid inside the cluster
              PAPERLESS_URL = "http://paperless-web.sentinel.svc.cluster.local"
              PAPERLESS_TOKEN = "48f16b10207d9f0ef48d82d04756e7e5bbb9511e"
              WEBUI_URL = "http://open-webui-service.sentinel.svc.cluster.local"
              WEBUI_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6IjU2YmY0NGRjLWM5MTgtNDAxMi1iMDNhLWYyODFjMWFlNzYzOSIsImV4cCI6MTc2ODMyNzI5MywianRpIjoiM2I4OWMyOGYtOWE1MC00NjZmLWFkM2YtMWM4Y2ZiNzUyZTk1In0.XaC0r8UVd1LAoKSVzCl1Ew2g6Quz-o-jgdTwNrLaXX0"
              COLLECTION_NAME = "Paperless"

              headers = {"Authorization": f"Bearer {WEBUI_KEY}"}
              p_headers = {"Authorization": f"Token {PAPERLESS_TOKEN}"}

              print(f"--- SYNC START: {COLLECTION_NAME} ---")

              # 1. Get Collection ID
              kb_id = None
              try:
                  resp = requests.get(f"{WEBUI_URL}/api/v1/knowledge/", headers=headers)
                  for kb in resp.json():
                      if kb["name"] == COLLECTION_NAME:
                          kb_id = kb["id"]
                          break
                  if not kb_id:
                      # If collection is missing, create it
                      r = requests.post(f"{WEBUI_URL}/api/v1/knowledge/create", json={"name": COLLECTION_NAME, "description": "Auto-sync", "data": {}}, headers=headers)
                      kb_id = r.json().get("id")
              except Exception as e:
                  print(f"Error checking WebUI: {e}")
                  sys.exit(1)

              # 2. Get Existing Files (to avoid duplicates)
              existing_files = {}
              try:
                  r = requests.get(f"{WEBUI_URL}/api/v1/files/", headers=headers)
                  for f in r.json():
                      existing_files[f["filename"]] = f["id"]
              except:
                  pass

              # 3. Fetch Paperless Docs
              try:
                  # Fetch last 50 docs
                  r = requests.get(f"{PAPERLESS_URL}/api/documents/?ordering=-created&page_size=50", headers=p_headers)
                  docs = r.json().get("results", [])
              except Exception as e:
                  print(f"Error checking Paperless: {e}")
                  sys.exit(1)

              # 4. Sync Logic
              new_count = 0
              for doc in docs:
                  title = doc.get("title", "Untitled")
                  fname = f"{title}.txt"
                  content = doc.get("content", "")
                  
                  if not content: continue

                  file_id = existing_files.get(fname)
                  
                  # Upload if missing
                  if not file_id:
                      files = {"file": (fname, content, "text/plain")}
                      up = requests.post(f"{WEBUI_URL}/api/v1/files/", files=files, headers=headers)
                      if up.status_code == 200:
                          file_id = up.json()["id"]
                          print(f"[UPLOADED] {fname}")
                      else:
                          print(f"[ERROR] Failed upload {fname}")
                          continue
                  
                  # Link to Collection
                  if file_id and kb_id:
                      link = requests.post(f"{WEBUI_URL}/api/v1/knowledge/{kb_id}/file/add", json={"file_id": file_id}, headers=headers)
                      if link.status_code == 200:
                          new_count += 1

              print(f"--- SYNC COMPLETE. Processed {new_count} items. ---")
              '
          restartPolicy: OnFailure
